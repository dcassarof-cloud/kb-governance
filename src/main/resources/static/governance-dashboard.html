<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard de Governan√ßa - KB Consisa</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        .header {
            background: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            margin-bottom: 30px;
        }

        .header h1 {
            color: #2d3748;
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        .header p {
            color: #718096;
            font-size: 1.1em;
        }

        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .metric-card {
            background: white;
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            position: relative;
            overflow: hidden;
        }

        .metric-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
        }

        .metric-card.total::before { background: #3b82f6; }
        .metric-card.ready::before { background: #10b981; }
        .metric-card.empty::before { background: #ef4444; }
        .metric-card.short::before { background: #f59e0b; }
        .metric-card.no-structure::before { background: #6b7280; }

        .metric-label {
            color: #718096;
            font-size: 0.9em;
            margin-bottom: 10px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .metric-value {
            color: #2d3748;
            font-size: 2.5em;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .metric-subtitle {
            color: #a0aec0;
            font-size: 0.85em;
        }

        .progress-section {
            background: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            margin-bottom: 30px;
        }

        .progress-section h2 {
            color: #2d3748;
            margin-bottom: 20px;
        }

        .progress-bar-container {
            background: #e2e8f0;
            height: 40px;
            border-radius: 20px;
            overflow: hidden;
            position: relative;
        }

        .progress-bar {
            background: linear-gradient(90deg, #10b981 0%, #059669 100%);
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: width 1s ease;
            color: white;
            font-weight: bold;
            font-size: 1.1em;
        }

        .issues-section {
            background: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        .issues-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .issues-header h2 {
            color: #2d3748;
        }

        .filter-buttons {
            display: flex;
            gap: 10px;
        }

        .filter-btn {
            padding: 8px 16px;
            border: 2px solid #e2e8f0;
            background: white;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 0.9em;
        }

        .filter-btn:hover {
            background: #f7fafc;
        }

        .filter-btn.active {
            background: #667eea;
            color: white;
            border-color: #667eea;
        }

        .issues-table {
            width: 100%;
            border-collapse: collapse;
        }

        .issues-table th {
            background: #f7fafc;
            padding: 15px;
            text-align: left;
            color: #4a5568;
            font-weight: 600;
            border-bottom: 2px solid #e2e8f0;
        }

        .issues-table td {
            padding: 15px;
            border-bottom: 1px solid #e2e8f0;
        }

        .issues-table tr:hover {
            background: #f7fafc;
        }

        .badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 0.8em;
            font-weight: 600;
            margin: 2px;
        }

        .badge.vazio { background: #fee2e2; color: #991b1b; }
        .badge.curto { background: #fef3c7; color: #92400e; }
        .badge.duplicado { background: #e9d5ff; color: #6b21a8; }
        .badge.sem-estrutura { background: #e5e7eb; color: #1f2937; }

        .score-bar {
            width: 100px;
            height: 8px;
            background: #e2e8f0;
            border-radius: 4px;
            overflow: hidden;
            display: inline-block;
            vertical-align: middle;
            margin-right: 8px;
        }

        .score-fill {
            height: 100%;
            transition: width 0.5s;
        }

        .score-fill.high { background: #10b981; }
        .score-fill.medium { background: #f59e0b; }
        .score-fill.low { background: #ef4444; }

        .loading {
            text-align: center;
            padding: 40px;
            color: #718096;
        }

        .spinner {
            border: 4px solid #e2e8f0;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .btn-link {
            color: #667eea;
            text-decoration: none;
            font-weight: 500;
        }

        .btn-link:hover {
            text-decoration: underline;
        }
    </style>
</head>
<body>
<div class="container">
    <!-- Header -->
    <div class="header">
        <h1>üìä Dashboard de Governan√ßa da KB</h1>
        <p>An√°lise de qualidade dos manuais para prepara√ß√£o IA</p>
    </div>

    <!-- M√©tricas -->
    <div class="metrics-grid" id="metrics">
        <div class="loading">
            <div class="spinner"></div>
            Carregando estat√≠sticas...
        </div>
    </div>

    <!-- Progresso IA-Ready -->
    <div class="progress-section" id="progress-section" style="display: none;">
        <h2>ü§ñ Progresso IA-Ready</h2>
        <div class="progress-bar-container">
            <div class="progress-bar" id="progress-bar">0%</div>
        </div>
        <p style="margin-top: 10px; color: #718096;" id="progress-text"></p>
    </div>

    <!-- Tabela de Issues -->
    <div class="issues-section" id="issues-section" style="display: none;">
        <div class="issues-header">
            <h2>‚ö†Ô∏è Artigos com Problemas</h2>
            <div class="filter-buttons">
                <button class="filter-btn active" onclick="filterIssues('all')">Todos</button>
                <button class="filter-btn" onclick="filterIssues('empty')">Vazios</button>
                <button class="filter-btn" onclick="filterIssues('short')">Curtos</button>
                <button class="filter-btn" onclick="filterIssues('duplicate')">Duplicados</button>
                <button class="filter-btn" onclick="filterIssues('no-structure')">Sem Estrutura</button>
            </div>
        </div>

        <div style="overflow-x: auto;">
            <table class="issues-table">
                <thead>
                <tr>
                    <th>Artigo</th>
                    <th>Sistema</th>
                    <th>Problemas</th>
                    <th>Score</th>
                    <th>A√ß√µes</th>
                </tr>
                </thead>
                <tbody id="issues-tbody">
                <tr>
                    <td colspan="5" class="loading">
                        <div class="spinner"></div>
                        Carregando artigos...
                    </td>
                </tr>
                </tbody>
            </table>
        </div>
    </div>
</div>

<script>
    let allIssues = [];

    // Carrega dados ao iniciar
    async function loadDashboard() {
        await loadStats();
        await loadIssues();
    }

    // Carrega estat√≠sticas
    async function loadStats() {
        try {
            const res = await fetch('/kb/governance/report/stats');
            const stats = await res.json();

            // Atualiza m√©tricas
            document.getElementById('metrics').innerHTML = `
                    <div class="metric-card total">
                        <div class="metric-label">Total de Artigos</div>
                        <div class="metric-value">${stats.total.toLocaleString()}</div>
                    </div>

                    <div class="metric-card ready">
                        <div class="metric-label">IA Ready</div>
                        <div class="metric-value">${stats.iaReadyCount.toLocaleString()}</div>
                        <div class="metric-subtitle">${stats.iaReadyPercentage}%</div>
                    </div>

                    <div class="metric-card empty">
                        <div class="metric-label">Vazios</div>
                        <div class="metric-value">${stats.emptyCount.toLocaleString()}</div>
                    </div>

                    <div class="metric-card short">
                        <div class="metric-label">Curtos</div>
                        <div class="metric-value">${stats.shortCount.toLocaleString()}</div>
                    </div>

                    <div class="metric-card no-structure">
                        <div class="metric-label">Sem Estrutura</div>
                        <div class="metric-value">${stats.noStructureCount.toLocaleString()}</div>
                    </div>
                `;

            // Atualiza progresso
            document.getElementById('progress-section').style.display = 'block';
            document.getElementById('progress-bar').style.width = stats.iaReadyPercentage + '%';
            document.getElementById('progress-bar').textContent = stats.iaReadyPercentage + '%';
            document.getElementById('progress-text').textContent =
                `${stats.iaReadyCount} de ${stats.total} artigos prontos para IA`;

        } catch (error) {
            console.error('Erro ao carregar stats:', error);
            document.getElementById('metrics').innerHTML =
                '<div class="loading">‚ùå Erro ao carregar estat√≠sticas</div>';
        }
    }

    // Carrega issues
    async function loadIssues() {
        try {
            const res = await fetch('/kb/governance/report/issues');
            allIssues = await res.json();

            document.getElementById('issues-section').style.display = 'block';
            renderIssues(allIssues);

        } catch (error) {
            console.error('Erro ao carregar issues:', error);
            document.getElementById('issues-tbody').innerHTML =
                '<tr><td colspan="5" class="loading">‚ùå Erro ao carregar artigos</td></tr>';
        }
    }

    // Renderiza tabela de issues
    function renderIssues(issues) {
        const tbody = document.getElementById('issues-tbody');

        if (issues.length === 0) {
            tbody.innerHTML = '<tr><td colspan="5" style="text-align: center; padding: 40px; color: #10b981;">‚úÖ Nenhum artigo com problemas!</td></tr>';
            return;
        }

        tbody.innerHTML = issues.slice(0, 100).map(issue => `
                <tr>
                    <td>
                        <strong>${issue.title || 'Sem t√≠tulo'}</strong><br>
                        <small style="color: #a0aec0;">ID: ${issue.articleId}</small>
                    </td>
                    <td>${issue.systemCode || 'N/A'}</td>
                    <td>
                        ${issue.actions.map(action => {
            const badgeClass = action.includes('VAZIO') ? 'vazio' :
                action.includes('CURTO') ? 'curto' :
                    action.includes('DUPLICADO') ? 'duplicado' :
                        'sem-estrutura';
            const label = action.replace('MANUAL_', '').replace('_', ' ');
            return `<span class="badge ${badgeClass}">${label}</span>`;
        }).join('')}
                    </td>
                    <td>
                        <div class="score-bar">
                            <div class="score-fill ${issue.qualityScore >= 80 ? 'high' : issue.qualityScore >= 60 ? 'medium' : 'low'}"
                                 style="width: ${issue.qualityScore}%"></div>
                        </div>
                        <span style="font-weight: 600; color: ${issue.qualityScore >= 80 ? '#10b981' : issue.qualityScore >= 60 ? '#f59e0b' : '#ef4444'}">
                            ${issue.qualityScore}
                        </span>
                    </td>
                    <td>
                        <a href="${issue.sourceUrl}" target="_blank" class="btn-link">Ver no Movidesk</a>
                    </td>
                </tr>
            `).join('');
    }

    // Filtro de issues
    function filterIssues(type) {
        // Atualiza bot√µes ativos
        document.querySelectorAll('.filter-btn').forEach(btn => btn.classList.remove('active'));
        event.target.classList.add('active');

        // Filtra issues
        let filtered = allIssues;

        if (type === 'empty') {
            filtered = allIssues.filter(i => i.actions.includes('MANUAL_VAZIO'));
        } else if (type === 'short') {
            filtered = allIssues.filter(i => i.actions.includes('MANUAL_CURTO_DEMAIS'));
        } else if (type === 'duplicate') {
            filtered = allIssues.filter(i => i.actions.includes('MANUAL_DUPLICADO_NO_MESMO_SISTEMA'));
        } else if (type === 'no-structure') {
            filtered = allIssues.filter(i => i.actions.includes('MANUAL_SEM_ESTRUTURA_MINIMA'));
        }

        renderIssues(filtered);
    }

    // Carrega ao abrir a p√°gina
    loadDashboard();
</script>
</body>
</html>