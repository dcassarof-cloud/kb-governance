<!doctype html>
<html lang="pt-br">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1"/>
    <title>KB Governance - Sync Control</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 24px; max-width: 920px; }
        .row { display:flex; gap:12px; flex-wrap:wrap; align-items:center; margin: 10px 0; }
        input, select { padding: 8px; }
        button { padding: 10px 14px; cursor:pointer; }
        button:disabled { opacity: .6; cursor: not-allowed; }
        pre { background:#f6f6f6; padding: 12px; overflow:auto; border-radius: 10px; }
        .card { border:1px solid #ddd; padding: 14px; border-radius: 10px; margin-top: 12px; }
        .meta { font-size: 12px; color:#555; margin-top: 6px; }
        .status { font-size: 13px; margin-top: 8px; }
    </style>
</head>
<body>
<h1>KB Sync Control</h1>

<div class="card">
    <h3>Config</h3>
    <div class="row">
        <label><input type="checkbox" id="enabled"> enabled</label>

        <label>mode:
            <select id="mode">
                <option value="DELTA_WINDOW">DELTA_WINDOW</option>
                <option value="FULL">FULL</option>
            </select>
        </label>

        <label>intervalMinutes:
            <input id="intervalMinutes" type="number" min="1" value="60">
        </label>

        <label>daysBack:
            <input id="daysBack" type="number" min="0" value="2">
        </label>

        <button onclick="safe(loadConfig)">Recarregar</button>
        <button onclick="safe(saveConfig)">Salvar</button>
    </div>

    <div id="cfgMeta" class="meta"></div>
</div>

<div class="card">
    <h3>Run</h3>
    <div class="row">
        <button onclick="safe(() => runNow('DELTA_WINDOW'))">Rodar DELTA_WINDOW agora</button>
        <button onclick="safe(() => runNow('FULL'))">Rodar FULL agora</button>
        <button onclick="safe(loadLatestRun)">Ver último run</button>
    </div>

    <div id="status" class="status"></div>
    <pre id="out">...</pre>
</div>

<script>
    const API_BASE = window.location.origin; // ex: http://localhost:8080

    function setStatus(msg) {
        document.getElementById("status").innerText = msg || "";
    }

    function setOut(objOrText) {
        const out = document.getElementById("out");
        if (typeof objOrText === "string") out.innerText = objOrText;
        else out.innerText = JSON.stringify(objOrText, null, 2);
    }

    function setBusy(busy) {
        document.querySelectorAll("button").forEach(b => b.disabled = busy);
    }

    async function http(path, opts) {
        const url = API_BASE + path;
        const res = await fetch(url, opts);
        const text = await res.text();

        let data = null;
        try { data = text ? JSON.parse(text) : null; } catch {}

        if (!res.ok) {
            const msg = (data && (data.message || data.error)) ? (data.message || data.error) : (text || res.statusText);
            throw new Error(msg);
        }

        return data;
    }

    async function safe(fn) {
        setBusy(true);
        try {
            await fn();
        } catch(e) {
            setStatus("❌ " + e.message);
            setOut("Erro: " + e.message);
        } finally {
            setBusy(false);
        }
    }

    async function loadConfig() {
        setStatus("⏳ Carregando config...");
        const cfg = await http("/kb/sync/config");

        document.getElementById("enabled").checked = !!cfg.enabled;
        document.getElementById("mode").value = cfg.mode || "DELTA_WINDOW";
        document.getElementById("intervalMinutes").value = cfg.intervalMinutes ?? 60;
        document.getElementById("daysBack").value = cfg.daysBack ?? 2;

        document.getElementById("cfgMeta").innerText =
            `lastStartedAt=${cfg.lastStartedAt || "-"} | lastFinishedAt=${cfg.lastFinishedAt || "-"}`;

        setStatus("✅ Config carregada.");
        setOut(cfg);
    }

    async function saveConfig() {
        setStatus("⏳ Salvando config...");
        const body = {
            enabled: document.getElementById("enabled").checked,
            mode: document.getElementById("mode").value,
            intervalMinutes: parseInt(document.getElementById("intervalMinutes").value, 10),
            daysBack: parseInt(document.getElementById("daysBack").value, 10)
        };

        const saved = await http("/kb/sync/config", {
            method: "PUT",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(body)
        });

        setStatus("✅ Config salva.");
        setOut(saved);
        await loadConfig();
    }

    async function runNow(mode) {
        setStatus("⏳ Rodando sync...");
        const daysBack = parseInt(document.getElementById("daysBack").value, 10);
        const url = `/kb/sync/run?mode=${encodeURIComponent(mode)}` + (mode === "DELTA_WINDOW" ? `&daysBack=${encodeURIComponent(daysBack)}` : "");

        const run = await http(url, { method: "POST" });

        setStatus("✅ Run disparado.");
        setOut(run);
    }

    async function loadLatestRun() {
        setStatus("⏳ Buscando último run...");
        const run = await http("/kb/sync/runs/latest");
        setStatus("✅ Último run carregado.");
        setOut(run);
    }

    // auto-load
    safe(loadConfig);
</script>
</body>
</html>

